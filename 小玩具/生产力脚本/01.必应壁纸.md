## 理论基础

- 通过http://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US 可以获取bing壁纸的信息
- 得到的结果中解析到url可以直接获取到最终的图片结果
- 请求可以通过python的requests模块获取，解析json字符串得到最后的url
- 最后通过win32api对壁纸进行设置即可。也可以使用ctypes设置壁纸

## 实现

```python
#!/usr/bin/env python
# coding: utf-8

import requests
import json
import PIL.Image as Image
import win32api,win32con,win32gui
import os

url = "http://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US"
# 需要替换保存路径
path = 'C:/Users/{user}/Pictures/Camera Roll'

def getImageInfo(url):
    r = requests.get(url)
    return json.loads(str(r.content, 'utf-8'))

def downloadImage(uri):
    img = requests.get(uri)
    if uri.find('&') == -1 :
        name = uri[uri.find('th?id=') + len('th?id='):]
    else:
        name = uri[uri.find('th?id=') + len('th?id=') : uri.find('&')]
    with open(path + '/' + name, 'wb') as f :
        f.write(img.content)
        return name

def set_wallpaper_from_bmp(bmp_path):
    #打开指定注册表路径
    reg_key = win32api.RegOpenKeyEx(win32con.HKEY_CURRENT_USER,"Control Panel\\Desktop",0,win32con.KEY_SET_VALUE)
    #最后的参数:2拉伸,0居中,6适应,10填充,0平铺
    win32api.RegSetValueEx(reg_key, "WallpaperStyle", 0, win32con.REG_SZ, "2")
    #最后的参数:1表示平铺,拉伸居中等都是0
    win32api.RegSetValueEx(reg_key, "TileWallpaper", 0, win32con.REG_SZ, "0")
    #刷新桌面
    win32gui.SystemParametersInfo(win32con.SPI_SETDESKWALLPAPER,bmp_path, win32con.SPIF_SENDWININICHANGE)

def set_wallpaper(img_path):
    #把图片格式统一转换成bmp格式,并放在源图片的同一目录
    img_dir = os.path.dirname(img_path)
    bmpImage = Image.open(img_path)
    new_bmp_path = os.path.join(img_dir,'wallpaper.bmp')
    bmpImage.save(new_bmp_path, "BMP")
    set_wallpaper_from_bmp(new_bmp_path)

if __name__ == '__main__':
    print('开始查询bing壁纸信息...')
    data = getImageInfo(url)
    os.makedirs(path, exist_ok=True)
    uri = "http://www.bing.com" + data['images'][0]['url']
    print('查询成功，壁纸链接为:' + uri)
    print('开始下载壁纸，下载路径为:' + path)
    img = path + '/' + downloadImage(uri)
    print('下载完成，壁纸名为：' + img)
    print('开始设置桌面壁纸....')
    set_wallpaper(img)
    print('设置成功，按任意键结束')
    input()
```

## 使用
如果出现包不存在，使用 `pip` 进行安装即可。如果想要每天更换壁纸，Linux或者MacOS可以使用 `crontab` 定时任务脚本进行设置
```bash
python bing.py
```

## 存在的问题
- 电脑重启后，壁纸失效，需要重新设置